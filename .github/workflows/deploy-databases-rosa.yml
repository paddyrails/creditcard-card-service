name: Deploy PostgreSQL Databases to ROSA

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - delete
          - status

env:
  NAMESPACE: creditcard
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  DB_USERNAME: dbadmin
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

jobs:
  deploy-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'deploy' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true

      - name: Create namespace if not exists
        run: |
          oc get namespace ${{ env.NAMESPACE }} || oc create namespace ${{ env.NAMESPACE }}
          oc project ${{ env.NAMESPACE }}

      - name: Check available storage classes
        run: |
          echo "=== Available Storage Classes ==="
          oc get storageclass
          echo ""
          DEFAULT_SC=$(oc get storageclass -o jsonpath='{.items[?(@.metadata.annotations.storageclass\.kubernetes\.io/is-default-class=="true")].metadata.name}')
          echo "Default Storage Class: ${DEFAULT_SC:-'None found'}"

      - name: Deploy Card Database
        run: |
          cat <<EOF | oc apply -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: creditcard-card-db-secret
            namespace: ${{ env.NAMESPACE }}
          type: Opaque
          stringData:
            database-name: carddb
            database-user: ${{ env.DB_USERNAME }}
            database-password: ${{ env.DB_PASSWORD }}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: creditcard-card-db-pvc
            namespace: ${{ env.NAMESPACE }}
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: creditcard-card-db
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: creditcard-card-db
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: creditcard-card-db
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: creditcard-card-db
              spec:
                containers:
                  - name: postgresql
                    image: bitnami/postgresql:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRESQL_DATABASE
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-card-db-secret
                            key: database-name
                      - name: POSTGRESQL_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-card-db-secret
                            key: database-user
                      - name: POSTGRESQL_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-card-db-secret
                            key: database-password
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /bitnami/postgresql
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d carddb
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d carddb
                      initialDelaySeconds: 60
                      periodSeconds: 10
                      timeoutSeconds: 5
                volumes:
                  - name: postgres-storage
                    persistentVolumeClaim:
                      claimName: creditcard-card-db-pvc
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: creditcard-card-db
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 5432
                targetPort: 5432
            selector:
              app: creditcard-card-db
          EOF
          echo "✓ Card database deployed"

      - name: Deploy Account Database
        run: |
          cat <<EOF | oc apply -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: creditcard-account-db-secret
            namespace: ${{ env.NAMESPACE }}
          type: Opaque
          stringData:
            database-name: accountdb
            database-user: ${{ env.DB_USERNAME }}
            database-password: ${{ env.DB_PASSWORD }}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: creditcard-account-db-pvc
            namespace: ${{ env.NAMESPACE }}
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: creditcard-account-db
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: creditcard-account-db
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: creditcard-account-db
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: creditcard-account-db
              spec:
                containers:
                  - name: postgresql
                    image: bitnami/postgresql:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRESQL_DATABASE
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-account-db-secret
                            key: database-name
                      - name: POSTGRESQL_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-account-db-secret
                            key: database-user
                      - name: POSTGRESQL_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-account-db-secret
                            key: database-password
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /bitnami/postgresql
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d accountdb
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d accountdb
                      initialDelaySeconds: 60
                      periodSeconds: 10
                      timeoutSeconds: 5
                volumes:
                  - name: postgres-storage
                    persistentVolumeClaim:
                      claimName: creditcard-account-db-pvc
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: creditcard-account-db
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 5432
                targetPort: 5432
            selector:
              app: creditcard-account-db
          EOF
          echo "✓ Account database deployed"

      - name: Deploy Statement Database
        run: |
          cat <<EOF | oc apply -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: creditcard-statement-db-secret
            namespace: ${{ env.NAMESPACE }}
          type: Opaque
          stringData:
            database-name: statementdb
            database-user: ${{ env.DB_USERNAME }}
            database-password: ${{ env.DB_PASSWORD }}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: creditcard-statement-db-pvc
            namespace: ${{ env.NAMESPACE }}
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: creditcard-statement-db
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: creditcard-statement-db
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: creditcard-statement-db
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: creditcard-statement-db
              spec:
                containers:
                  - name: postgresql
                    image: bitnami/postgresql:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRESQL_DATABASE
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-statement-db-secret
                            key: database-name
                      - name: POSTGRESQL_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-statement-db-secret
                            key: database-user
                      - name: POSTGRESQL_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-statement-db-secret
                            key: database-password
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /bitnami/postgresql
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d statementdb
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d statementdb
                      initialDelaySeconds: 60
                      periodSeconds: 10
                      timeoutSeconds: 5
                volumes:
                  - name: postgres-storage
                    persistentVolumeClaim:
                      claimName: creditcard-statement-db-pvc
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: creditcard-statement-db
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 5432
                targetPort: 5432
            selector:
              app: creditcard-statement-db
          EOF
          echo "✓ Statement database deployed"

      - name: Deploy Payment Database
        run: |
          cat <<EOF | oc apply -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: creditcard-payment-db-secret
            namespace: ${{ env.NAMESPACE }}
          type: Opaque
          stringData:
            database-name: paymentdb
            database-user: ${{ env.DB_USERNAME }}
            database-password: ${{ env.DB_PASSWORD }}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: creditcard-payment-db-pvc
            namespace: ${{ env.NAMESPACE }}
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: creditcard-payment-db
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: creditcard-payment-db
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: creditcard-payment-db
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: creditcard-payment-db
              spec:
                containers:
                  - name: postgresql
                    image: bitnami/postgresql:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRESQL_DATABASE
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-payment-db-secret
                            key: database-name
                      - name: POSTGRESQL_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-payment-db-secret
                            key: database-user
                      - name: POSTGRESQL_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-payment-db-secret
                            key: database-password
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /bitnami/postgresql
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d paymentdb
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U ${{ env.DB_USERNAME }} -d paymentdb
                      initialDelaySeconds: 60
                      periodSeconds: 10
                      timeoutSeconds: 5
                volumes:
                  - name: postgres-storage
                    persistentVolumeClaim:
                      claimName: creditcard-payment-db-pvc
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: creditcard-payment-db
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 5432
                targetPort: 5432
            selector:
              app: creditcard-payment-db
          EOF
          echo "✓ Payment database deployed"

      - name: Check PVC status
        run: |
          echo "=== PVC Status ==="
          oc get pvc -n ${{ env.NAMESPACE }}
          echo ""
          echo "Waiting 30s for PVCs to bind..."
          sleep 30
          oc get pvc -n ${{ env.NAMESPACE }}

      - name: Wait for databases to be ready
        run: |
          echo "Waiting for databases to be ready (timeout: 5 minutes each)..."
          for db in card account statement payment; do
            echo "Waiting for creditcard-${db}-db..."
            oc rollout status deployment/creditcard-${db}-db -n ${{ env.NAMESPACE }} --timeout=300s || {
              echo "Timeout waiting for creditcard-${db}-db. Checking pod status..."
              oc get pods -l app=creditcard-${db}-db -n ${{ env.NAMESPACE }}
              oc describe pod -l app=creditcard-${db}-db -n ${{ env.NAMESPACE }} | tail -30
            }
          done

      - name: Get database info
        run: |
          echo "=== Database Deployments ==="
          oc get deployments -n ${{ env.NAMESPACE }} | grep db
          echo ""
          echo "=== Database Services ==="
          oc get services -n ${{ env.NAMESPACE }} | grep db
          echo ""
          echo "=== Database Pods ==="
          oc get pods -n ${{ env.NAMESPACE }} | grep db

      - name: Deployment Summary
        run: |
          echo "## PostgreSQL Databases Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** bitnami/postgresql:15 (OpenShift compatible)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Database | Service Name | Database Name | Port | User |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------------|---------------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Card | creditcard-card-db | carddb | 5432 | ${{ env.DB_USERNAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Account | creditcard-account-db | accountdb | 5432 | ${{ env.DB_USERNAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Statement | creditcard-statement-db | statementdb | 5432 | ${{ env.DB_USERNAME }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Payment | creditcard-payment-db | paymentdb | 5432 | ${{ env.DB_USERNAME }} |" >> $GITHUB_STEP_SUMMARY

  status-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'status' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc project ${{ env.NAMESPACE }}

      - name: Check status
        run: |
          echo "=== PVC Status ==="
          oc get pvc -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Deployments ==="
          oc get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          oc get pods -n ${{ env.NAMESPACE }} -o wide
          echo ""
          echo "=== Services ==="
          oc get services -n ${{ env.NAMESPACE }}
          echo ""
          for db in card account statement payment; do
            echo "=== creditcard-${db}-db Pod Details ==="
            oc describe pod -l app=creditcard-${db}-db -n ${{ env.NAMESPACE }} | grep -A 20 "Events:" || echo "No events"
            echo ""
          done

  delete-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'delete' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc project ${{ env.NAMESPACE }}

      - name: Delete all databases
        run: |
          for db in card account statement payment; do
            echo "Deleting creditcard-${db}-db..."
            oc delete deployment creditcard-${db}-db -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete service creditcard-${db}-db -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete pvc creditcard-${db}-db-pvc -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete secret creditcard-${db}-db-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          done
          echo "✓ All databases deleted"

      - name: Deletion Summary
        run: |
          echo "## PostgreSQL Databases Deleted" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All database resources have been removed from namespace: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
