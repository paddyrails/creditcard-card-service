name: Deploy to ROSA

on:
  workflow_run:
    workflows: ["Build and Push to ECR"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: latest)'
        required: false
        default: 'latest'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: creditcard-card-service
  SERVICE_NAME: creditcard-card-service
  NAMESPACE: creditcard
  DB_HOST: creditcard-card-db
  DB_PORT: "5432"
  DB_NAME: carddb
  DB_USERNAME: dbadmin

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to OpenShift
        run: |
          oc login --token=${{ secrets.OPENSHIFT_TOKEN }} --server=${{ secrets.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true

      - name: Setup namespace
        run: |
          oc get namespace ${{ env.NAMESPACE }} || oc create namespace ${{ env.NAMESPACE }}
          oc project ${{ env.NAMESPACE }}

      - name: Create ECR pull secret
        run: |
          ECR_PASSWORD=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          
          oc delete secret ecr-pull-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          oc create secret docker-registry ecr-pull-secret \
            --docker-server=${ECR_REGISTRY} \
            --docker-username=AWS \
            --docker-password=${ECR_PASSWORD} \
            -n ${{ env.NAMESPACE }}
          oc secrets link default ecr-pull-secret --for=pull -n ${{ env.NAMESPACE }}

      - name: Create ConfigMap and Secret
        run: |
          # Delete and recreate to ensure latest values
          oc delete configmap ${{ env.SERVICE_NAME }}-config -n ${{ env.NAMESPACE }} --ignore-not-found=true
          oc delete secret ${{ env.SERVICE_NAME }}-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          
          oc create configmap ${{ env.SERVICE_NAME }}-config \
            --from-literal=SPRING_PROFILES_ACTIVE=prod \
            --from-literal=DB_HOST=${{ env.DB_HOST }} \
            --from-literal=DB_PORT=${{ env.DB_PORT }} \
            --from-literal=DB_NAME=${{ env.DB_NAME }} \
            --from-literal=DB_USERNAME=${{ env.DB_USERNAME }} \
            -n ${{ env.NAMESPACE }}
          
          oc create secret generic ${{ env.SERVICE_NAME }}-secret \
            --from-literal=DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            -n ${{ env.NAMESPACE }}
          
          echo "âœ“ ConfigMap and Secret created"
          echo "DB_HOST = ${{ env.DB_HOST }}"

      - name: Deploy application
        run: |
          ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG=${{ steps.image-tag.outputs.tag }}
          FULL_IMAGE="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}:${IMAGE_TAG}"
          
          echo "Deploying image: ${FULL_IMAGE}"
          
          cat <<EOF | oc apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: ${{ env.SERVICE_NAME }}
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: ${{ env.SERVICE_NAME }}
            strategy:
              type: RollingUpdate
              rollingUpdate:
                maxSurge: 1
                maxUnavailable: 0
            template:
              metadata:
                labels:
                  app: ${{ env.SERVICE_NAME }}
              spec:
                imagePullSecrets:
                  - name: ecr-pull-secret
                containers:
                  - name: ${{ env.SERVICE_NAME }}
                    image: ${FULL_IMAGE}
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 8080
                        protocol: TCP
                    env:
                      - name: SPRING_PROFILES_ACTIVE
                        valueFrom:
                          configMapKeyRef:
                            name: ${{ env.SERVICE_NAME }}-config
                            key: SPRING_PROFILES_ACTIVE
                      - name: DB_HOST
                        valueFrom:
                          configMapKeyRef:
                            name: ${{ env.SERVICE_NAME }}-config
                            key: DB_HOST
                      - name: DB_PORT
                        valueFrom:
                          configMapKeyRef:
                            name: ${{ env.SERVICE_NAME }}-config
                            key: DB_PORT
                      - name: DB_NAME
                        valueFrom:
                          configMapKeyRef:
                            name: ${{ env.SERVICE_NAME }}-config
                            key: DB_NAME
                      - name: DB_USERNAME
                        valueFrom:
                          configMapKeyRef:
                            name: ${{ env.SERVICE_NAME }}-config
                            key: DB_USERNAME
                      - name: DB_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: ${{ env.SERVICE_NAME }}-secret
                            key: DB_PASSWORD
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "250m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                    livenessProbe:
                      httpGet:
                        path: /actuator/health/liveness
                        port: 8080
                      initialDelaySeconds: 90
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 3
                    readinessProbe:
                      httpGet:
                        path: /actuator/health/readiness
                        port: 8080
                      initialDelaySeconds: 60
                      periodSeconds: 5
                      timeoutSeconds: 3
                      failureThreshold: 3
                    startupProbe:
                      httpGet:
                        path: /actuator/health
                        port: 8080
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                      failureThreshold: 30
          EOF

      - name: Create Service
        run: |
          cat <<EOF | oc apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 8080
                targetPort: 8080
                name: http
            selector:
              app: ${{ env.SERVICE_NAME }}
          EOF

      - name: Create Route
        run: |
          cat <<EOF | oc apply -f -
          apiVersion: route.openshift.io/v1
          kind: Route
          metadata:
            name: ${{ env.SERVICE_NAME }}
            namespace: ${{ env.NAMESPACE }}
          spec:
            to:
              kind: Service
              name: ${{ env.SERVICE_NAME }}
            port:
              targetPort: http
            tls:
              termination: edge
              insecureEdgeTerminationPolicy: Redirect
          EOF

      - name: Restart deployment
        run: |
          oc rollout restart deployment/${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }}

      - name: Wait for rollout
        run: |
          oc rollout status deployment/${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }} --timeout=300s

      - name: Show status
        run: |
          echo "=== Deployment ==="
          oc get deployment ${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          oc get pods -l app=${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Environment Variables ==="
          oc set env deployment/${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }} --list
          echo ""
          echo "=== Route ==="
          ROUTE_URL=$(oc get route ${{ env.SERVICE_NAME }} -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.host}')
          echo "URL: https://${ROUTE_URL}"
          echo "Swagger: https://${ROUTE_URL}/swagger-ui.html"
