name: Deploy PostgreSQL Databases to ROSA

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - delete
          - status
          - redeploy

env:
  NAMESPACE: creditcard
  OPENSHIFT_SERVER: ${{ secrets.OPENSHIFT_SERVER }}
  OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
  DB_USERNAME: dbadmin
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

jobs:
  redeploy-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'redeploy' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/
          oc version --client

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc project ${{ env.NAMESPACE }} || oc new-project ${{ env.NAMESPACE }}

      - name: Delete existing databases
        run: |
          echo "Cleaning up existing database resources..."
          for db in card account statement payment; do
            echo "Deleting creditcard-${db}-db resources..."
            oc delete deployment creditcard-${db}-db -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete service creditcard-${db}-db -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete pvc creditcard-${db}-db-pvc -n ${{ env.NAMESPACE }} --ignore-not-found=true --wait=true
            oc delete secret creditcard-${db}-db-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          done
          echo "Waiting for resources to be fully deleted..."
          sleep 15
          echo "✓ Cleanup complete"

      - name: Deploy all databases
        run: |
          for db_info in "card:carddb" "account:accountdb" "statement:statementdb" "payment:paymentdb"; do
            DB_NAME="${db_info%%:*}"
            DB_DATABASE="${db_info##*:}"
            
            echo "Deploying creditcard-${DB_NAME}-db..."
            
            cat <<EOF | oc apply -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: creditcard-${DB_NAME}-db-secret
            namespace: ${{ env.NAMESPACE }}
          type: Opaque
          stringData:
            database-name: ${DB_DATABASE}
            database-user: ${{ env.DB_USERNAME }}
            database-password: ${{ env.DB_PASSWORD }}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: creditcard-${DB_NAME}-db-pvc
            namespace: ${{ env.NAMESPACE }}
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 5Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: creditcard-${DB_NAME}-db
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: creditcard-${DB_NAME}-db
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: creditcard-${DB_NAME}-db
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: creditcard-${DB_NAME}-db
              spec:
                containers:
                  - name: postgresql
                    image: bitnami/postgresql:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRESQL_DATABASE
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-${DB_NAME}-db-secret
                            key: database-name
                      - name: POSTGRESQL_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-${DB_NAME}-db-secret
                            key: database-user
                      - name: POSTGRESQL_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-${DB_NAME}-db-secret
                            key: database-password
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /bitnami/postgresql
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U \$POSTGRESQL_USERNAME -d \$POSTGRESQL_DATABASE
                      initialDelaySeconds: 30
                      periodSeconds: 10
                      timeoutSeconds: 5
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U \$POSTGRESQL_USERNAME -d \$POSTGRESQL_DATABASE
                      initialDelaySeconds: 60
                      periodSeconds: 10
                      timeoutSeconds: 5
                volumes:
                  - name: postgres-storage
                    persistentVolumeClaim:
                      claimName: creditcard-${DB_NAME}-db-pvc
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: creditcard-${DB_NAME}-db
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 5432
                targetPort: 5432
            selector:
              app: creditcard-${DB_NAME}-db
          EOF
            echo "✓ creditcard-${DB_NAME}-db deployed"
          done

      - name: Wait for PVCs to bind
        run: |
          echo "Waiting for PVCs to bind..."
          for i in {1..30}; do
            PENDING=$(oc get pvc -n ${{ env.NAMESPACE }} --no-headers | grep -c Pending || true)
            if [ "$PENDING" -eq 0 ]; then
              echo "All PVCs bound!"
              break
            fi
            echo "Waiting... ($i/30) - $PENDING PVCs pending"
            sleep 10
          done
          oc get pvc -n ${{ env.NAMESPACE }}

      - name: Wait for databases to be ready
        run: |
          echo "Waiting for database pods to be ready..."
          for db in card account statement payment; do
            echo "Waiting for creditcard-${db}-db..."
            oc rollout status deployment/creditcard-${db}-db -n ${{ env.NAMESPACE }} --timeout=300s || {
              echo "⚠ Timeout for creditcard-${db}-db, checking status..."
              oc get pods -l app=creditcard-${db}-db -n ${{ env.NAMESPACE }}
              oc logs -l app=creditcard-${db}-db -n ${{ env.NAMESPACE }} --tail=30 || true
            }
          done

      - name: Show final status
        run: |
          echo "=== Final Status ==="
          echo ""
          echo "=== PVCs ==="
          oc get pvc -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Deployments ==="
          oc get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          oc get pods -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Services ==="
          oc get services -n ${{ env.NAMESPACE }}

      - name: Summary
        run: |
          echo "## Database Redeployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Database | Host | DB Name | User | Port |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|---------|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| Card | creditcard-card-db | carddb | dbadmin | 5432 |" >> $GITHUB_STEP_SUMMARY
          echo "| Account | creditcard-account-db | accountdb | dbadmin | 5432 |" >> $GITHUB_STEP_SUMMARY
          echo "| Statement | creditcard-statement-db | statementdb | dbadmin | 5432 |" >> $GITHUB_STEP_SUMMARY
          echo "| Payment | creditcard-payment-db | paymentdb | dbadmin | 5432 |" >> $GITHUB_STEP_SUMMARY

  deploy-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'deploy' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc project ${{ env.NAMESPACE }} || oc new-project ${{ env.NAMESPACE }}

      - name: Deploy all databases
        run: |
          for db_info in "card:carddb" "account:accountdb" "statement:statementdb" "payment:paymentdb"; do
            DB_NAME="${db_info%%:*}"
            DB_DATABASE="${db_info##*:}"
            
            echo "Deploying creditcard-${DB_NAME}-db..."
            
            cat <<EOF | oc apply -f -
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: creditcard-${DB_NAME}-db-secret
            namespace: ${{ env.NAMESPACE }}
          type: Opaque
          stringData:
            database-name: ${DB_DATABASE}
            database-user: ${{ env.DB_USERNAME }}
            database-password: ${{ env.DB_PASSWORD }}
          ---
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: creditcard-${DB_NAME}-db-pvc
            namespace: ${{ env.NAMESPACE }}
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 5Gi
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: creditcard-${DB_NAME}-db
            namespace: ${{ env.NAMESPACE }}
            labels:
              app: creditcard-${DB_NAME}-db
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: creditcard-${DB_NAME}-db
            strategy:
              type: Recreate
            template:
              metadata:
                labels:
                  app: creditcard-${DB_NAME}-db
              spec:
                containers:
                  - name: postgresql
                    image: bitnami/postgresql:15
                    ports:
                      - containerPort: 5432
                    env:
                      - name: POSTGRESQL_DATABASE
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-${DB_NAME}-db-secret
                            key: database-name
                      - name: POSTGRESQL_USERNAME
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-${DB_NAME}-db-secret
                            key: database-user
                      - name: POSTGRESQL_PASSWORD
                        valueFrom:
                          secretKeyRef:
                            name: creditcard-${DB_NAME}-db-secret
                            key: database-password
                    volumeMounts:
                      - name: postgres-storage
                        mountPath: /bitnami/postgresql
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "100m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
                    readinessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U \$POSTGRESQL_USERNAME -d \$POSTGRESQL_DATABASE
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    livenessProbe:
                      exec:
                        command:
                          - /bin/sh
                          - -c
                          - pg_isready -U \$POSTGRESQL_USERNAME -d \$POSTGRESQL_DATABASE
                      initialDelaySeconds: 60
                      periodSeconds: 10
                volumes:
                  - name: postgres-storage
                    persistentVolumeClaim:
                      claimName: creditcard-${DB_NAME}-db-pvc
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: creditcard-${DB_NAME}-db
            namespace: ${{ env.NAMESPACE }}
          spec:
            type: ClusterIP
            ports:
              - port: 5432
                targetPort: 5432
            selector:
              app: creditcard-${DB_NAME}-db
          EOF
            echo "✓ creditcard-${DB_NAME}-db deployed"
          done

      - name: Wait for databases
        run: |
          for db in card account statement payment; do
            oc rollout status deployment/creditcard-${db}-db -n ${{ env.NAMESPACE }} --timeout=300s || true
          done
          oc get pods -n ${{ env.NAMESPACE }}

  status-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'status' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc project ${{ env.NAMESPACE }}

      - name: Check status
        run: |
          echo "=== PVCs ==="
          oc get pvc -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Deployments ==="
          oc get deployments -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pods ==="
          oc get pods -n ${{ env.NAMESPACE }} -o wide
          echo ""
          echo "=== Services ==="
          oc get services -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Pod Events ==="
          for db in card account statement payment; do
            echo "--- creditcard-${db}-db ---"
            oc describe pod -l app=creditcard-${db}-db -n ${{ env.NAMESPACE }} 2>/dev/null | grep -A 15 "Events:" || echo "No pod found"
          done

  delete-databases:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.action == 'delete' }}
    
    steps:
      - name: Install OpenShift CLI
        run: |
          curl -sLO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf openshift-client-linux.tar.gz
          sudo mv oc kubectl /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login --token=${{ env.OPENSHIFT_TOKEN }} --server=${{ env.OPENSHIFT_SERVER }} --insecure-skip-tls-verify=true
          oc project ${{ env.NAMESPACE }}

      - name: Delete all databases
        run: |
          for db in card account statement payment; do
            echo "Deleting creditcard-${db}-db..."
            oc delete deployment creditcard-${db}-db -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete service creditcard-${db}-db -n ${{ env.NAMESPACE }} --ignore-not-found=true
            oc delete pvc creditcard-${db}-db-pvc -n ${{ env.NAMESPACE }} --ignore-not-found=true --wait=true
            oc delete secret creditcard-${db}-db-secret -n ${{ env.NAMESPACE }} --ignore-not-found=true
          done
          echo "✓ All databases deleted"
